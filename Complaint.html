<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Register Complaint ‚Äî Civil Eye</title>

  <!-- favicon -->
  <link rel="shortcut icon" href="images/logo.jpg" type="image/x-icon" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --primary:#1e3a8a;
      --accent:#e91e63;
      --light:#f0f4f8;
      --card-bg: #fff;
      --muted: #666;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--light), #ffffff);
      color:#222;
    }

    /* Navbar */
    .navbar{
      background:var(--card-bg);
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
      padding:0.6rem 0;
    }
    .navbar .brand-title{font-weight:800;color:var(--primary);letter-spacing:1px}
    .nav-link{color:var(--primary);font-weight:500}
    .nav-link:hover{color:var(--accent)}
    .btn-outline-cta{border:2px solid var(--accent);color:var(--accent);font-weight:600;border-radius:20px;padding:.35rem .9rem}
    .btn-outline-cta:hover{background:var(--accent);color:#fff}

    /* Header banner */
    .info-banner{background:var(--primary);color:#fff;padding:.6rem;font-size:.95rem;text-align:center}

    main{flex:1;padding:2.5rem 1rem}

    /* Card */
    .form-card{
      max-width:920px;margin:0 auto;background:var(--card-bg);
      border-radius:12px;padding:2.2rem;box-shadow:0 10px 30px rgba(5,10,30,0.06);
      transition:transform .18s;
    }
    .form-card:hover{transform:translateY(-4px)}

    h2{color:var(--primary);font-weight:800;margin-bottom:1rem}
    p.lead{color:var(--muted);margin-bottom:1.25rem}

    label{display:block;color:var(--primary);font-weight:600;margin-bottom:.5rem}
    .form-control, .form-select{
      border:2px solid #e9e9ee;padding:.75rem 1rem;border-radius:8px;font-size:1rem;
      transition:all .18s;background:#fff;
    }
    .form-control:focus, .form-select:focus{
      outline:none;border-color:var(--accent);box-shadow:0 0 0 5px rgba(233,30,99,0.06);
      background:#fff9fc;
    }

    /* image upload area */
    .image-upload-section{
      background: #fbfbff;border-radius:10px;padding:1.25rem;border:1px dashed rgba(30,58,138,0.12);
      text-align:center;
    }
    .upload-options{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;margin-top:.8rem}
    .upload-btn{
      background:var(--accent);color:#fff;border:none;padding:.6rem 1rem;border-radius:8px;font-weight:700;
      cursor:pointer;display:inline-flex;align-items:center;gap:.5rem;
    }
    .upload-btn:hover{transform:translateY(-2px);filter:brightness(.96)}

    .image-preview{
      display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.9rem;margin-top:1rem;
    }
    .preview-item{position:relative;border-radius:8px;overflow:hidden}
    .preview-img{width:100%;height:110px;object-fit:cover;display:block}
    .remove-btn{
      position:absolute;top:6px;right:6px;background:#ff4b4b;color:#fff;border:none;border-radius:50%;
      width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,0.12);
    }

    .btn-submit{
      width:100%;padding:1rem;margin-top:1rem;border-radius:10px;border:none;
      background:linear-gradient(90deg,var(--accent),#c2185b);color:#fff;font-weight:800;font-size:1.02rem;
      cursor:pointer;
    }
    .btn-submit:hover{transform:translateY(-3px);filter:brightness(.98)}

    .auth-status{
      display:flex;align-items:center;justify-content:space-between;padding:.6rem .8rem;margin-bottom:1rem;border-radius:8px;
      background:#f6fbff;border:1px solid rgba(30,58,138,0.06);color:var(--primary)
    }
    .auth-status .user{font-weight:700}
    .auth-status .signout{background:transparent;border:1px solid var(--primary);color:var(--primary);padding:.35rem .55rem;border-radius:6px;cursor:pointer}

    footer{background:var(--primary);color:#fff;padding:1.25rem;text-align:center;margin-top:2rem}

    /* Small screens */
    @media (max-width:576px){
      .form-card{padding:1.25rem}
      .image-preview{grid-template-columns:repeat(auto-fill,minmax(100px,1fr))}
      .preview-img{height:92px}
    }
  </style>
</head>
<body>

  <div class="info-banner">‚ÑπÔ∏è Secure reporting ‚Äî add details and photos to help authorities respond faster.</div>

  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid px-lg-4">
      <a class="navbar-brand d-flex align-items-center gap-2" href="Home.html">
        <img src="images/logo.jpg" alt="Civil Eye logo" width="34" height="34" style="border-radius:6px">
        <span class="brand-title">Civil Eye</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-3">
          <li class="nav-item"><a class="nav-link" href="Home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="history.html">My Complaints</a></li>
          <li class="nav-item"><a class="btn btn-outline-cta" href="signin.html">Sign In</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main>
    <div class="form-card">
      <div id="authStatus" class="auth-status" style="display:none">
        <div class="user">Signed in as <strong id="authName"></strong></div>
        <button id="signoutBtn" class="signout">Sign out</button>
      </div>

      <h2>Register a Complaint</h2>
      <p class="lead">Describe the issue and attach photos ‚Äî the more information, the better the response.</p>

      <form id="complaintForm" enctype="multipart/form-data" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label for="fullname">Full Name</label>
            <input id="fullname" name="fullname" class="form-control" type="text" placeholder="Your full name" required>
          </div>

          <div class="col-md-6">
            <label for="email">Email Address</label>
            <input id="email" name="email" class="form-control" type="email" placeholder="you@example.com" required>
          </div>

          <div class="col-12">
            <label for="location">Location / Address</label>
            <input id="location" name="location" class="form-control" type="text" placeholder="Street, area, city, landmark" required>
          </div>

          <div class="col-md-6">
            <label for="complaintType">Complaint Type</label>
            <select id="complaintType" name="complaintType" class="form-select" required>
              <option value="" disabled selected>Select complaint type</option>
              <option value="road_damage">Road Damage</option>
              <option value="water_supply">Water Supply Issue</option>
              <option value="public_safety">Public Safety Concern</option>
              <option value="utilities">Utilities Problem</option>
              <option value="sanitation">Sanitation Issue</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="col-12">
            <label for="description">Complaint Description</label>
            <textarea id="description" name="description" class="form-control" rows="5" placeholder="Describe the problem in detail" required></textarea>
          </div>

          <div class="col-12">
            <label>Attach Photos</label>
            <div class="image-upload-section">
              <div style="font-weight:700;color:var(--primary)">üì∏ Add photos to support your complaint</div>
              <div class="upload-options">
                <label class="upload-btn" for="galleryInput" role="button">üñºÔ∏è Upload from device</label>
                <label class="upload-btn" for="cameraInput" role="button">üì∑ Take photo</label>
              </div>

              <!-- hidden inputs -->
              <input id="galleryInput" type="file" accept="image/*" multiple style="display:none">
              <input id="cameraInput" type="file" accept="image/*" capture="environment" style="display:none">

              <div id="imagePreview" class="image-preview" aria-live="polite"></div>
              <small class="text-muted d-block mt-2">Accepted: jpg, png, jpeg. Max total upload size depends on server (16MB recommended).</small>
            </div>
          </div>

          <div class="col-12">
            <button type="submit" class="btn-submit">Submit Complaint</button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <footer>
    <div class="container text-center">
      <small>¬© <span id="year"></span> Civil Eye ‚Äî Report and Track Issues</small>
    </div>
  </footer>

  <!-- Scripts -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // uploadedImages holds objects {file, src}
    let uploadedImages = [];

    const galleryInput = document.getElementById('galleryInput');
    const cameraInput = document.getElementById('cameraInput');
    const imagePreview = document.getElementById('imagePreview');

    function handleFiles(filesList) {
      const files = Array.from(filesList);
      files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        // Optional: enforce filesize limit per file (e.g., 8MB)
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImages.push({ file, src: e.target.result });
          renderPreviews();
        };
        reader.readAsDataURL(file);
      });
    }

    galleryInput.addEventListener('change', (e) => handleFiles(e.target.files));
    cameraInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function renderPreviews() {
      imagePreview.innerHTML = '';
      uploadedImages.forEach((imgObj, idx) => {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.innerHTML = `
          <img class="preview-img" src="${imgObj.src}" alt="preview-${idx}" />
          <button type="button" class="remove-btn" title="Remove" data-index="${idx}">√ó</button>
        `;
        imagePreview.appendChild(item);
      });

      // attach remove handlers
      imagePreview.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const i = parseInt(ev.currentTarget.getAttribute('data-index'), 10);
          uploadedImages.splice(i, 1);
          renderPreviews();
        });
      });
    }

    // Submit form
    document.getElementById('complaintForm').addEventListener('submit', (e) => {
      // Basic client-side validation
      const fullname = document.getElementById('fullname').value.trim();
      const email = document.getElementById('email').value.trim();
      const location = document.getElementById('location').value.trim();
      const type = document.getElementById('complaintType').value;
      const description = document.getElementById('description').value.trim();

      if (!fullname || !email || !location || !type || !description) {
        e.preventDefault();
        alert('Please fill out all required fields.');
        return false;
      }
      // Form will POST naturally
    });

    // Auth check (if your backend provides /api/auth/me this will show signed-in user)
    document.addEventListener('DOMContentLoaded', async () => {
      const authStatus = document.getElementById('authStatus');
      const authName = document.getElementById('authName');
      const signoutBtn = document.getElementById('signoutBtn');
      try {
        const res = await fetch('http://localhost:5000/api/auth/me', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          // expected shape (if available): { type: 'user', user: { username, email } }
          if (data?.type === 'user' && data?.user) {
            authName.textContent = data.user.username || data.user.email || 'User';
            authStatus.style.display = 'flex';
            // enable signout
            signoutBtn.addEventListener('click', async () => {
              try {
                const r = await fetch('http://localhost:5000/api/auth/signout', { method: 'POST', credentials: 'include' });
                if (r.ok) location.reload();
              } catch (e) { console.error(e); }
            });
            return;
          }
        }
      } catch (err) {
        // backend might not have /api/auth/me ‚Äî ignore silently
        console.warn('Auth check failed or /api/auth/me not present.', err);
      }

      // If not signed in: disable form controls and show a friendly notice
      const form = document.getElementById('complaintForm');
      form.querySelectorAll('input, textarea, select, button').forEach(el => {
        // keep sign-in and history links usable ‚Äî only disable form fields and submit
        if (!(el.tagName === 'A' || el.classList.contains('nav-link'))) {
          el.disabled = el.tagName === 'BUTTON' || el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA';
        }
      });

      const card = document.querySelector('.form-card');
      const notice = document.createElement('div');
      notice.className = 'alert alert-warning';
      notice.style.marginTop = '1rem';
      notice.innerHTML = `You must <a href="signin.html" class="alert-link">sign in</a> to register a complaint.`;
      card.insertBefore(notice, card.firstChild);
    });
  </script>

  <!-- Bootstrap JS (Popper + bootstrap) -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"></script>
</body>
</html>
